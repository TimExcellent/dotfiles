#!/bin/zsh
# =============================================================================
# ZSH Configuration - Modern Terminal Setup
# =============================================================================
# CLI Tools: eza, bat, fd, ripgrep, zoxide, fzf, atuin, navi
# TUI Apps: lazygit, btop, yazi, glow, jless, lazydocker
# AI: Claude Code (terminal), avante.nvim (Neovim)
# =============================================================================

# === PATH ===
typeset -U path
path=(
  "$HOME/.local/bin"
  "/opt/homebrew/bin"
  "/opt/homebrew/sbin"
  "$HOME/.pyenv/bin"
  "$HOME/.deno/bin"
  $path
)
export PATH

# === ENVIRONMENT ===
export EDITOR="nvim"
export VISUAL="nvim"
export LANG="en_US.UTF-8"
export LC_ALL="en_US.UTF-8"

# === HISTORY ===
HISTFILE="$HOME/.zsh_history"
HISTSIZE=50000
SAVEHIST=50000
setopt EXTENDED_HISTORY SHARE_HISTORY HIST_EXPIRE_DUPS_FIRST
setopt HIST_IGNORE_DUPS HIST_IGNORE_ALL_DUPS HIST_FIND_NO_DUPS
setopt HIST_IGNORE_SPACE HIST_SAVE_NO_DUPS

# === OPTIONS ===
setopt AUTO_CD AUTO_PUSHD PUSHD_IGNORE_DUPS CORRECT NO_BEEP INTERACTIVE_COMMENTS

# === COMPLETION ===
autoload -Uz compinit && compinit
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'
zstyle ':completion:*' list-colors ''
zstyle ':completion:*' menu select
zstyle ':completion:*' verbose yes

# === AUTOSUGGESTIONS & SYNTAX HIGHLIGHTING ===
# Install: brew install zsh-autosuggestions zsh-syntax-highlighting
[[ -f /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh ]] && \
  source /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh
[[ -f /opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]] && \
  source /opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh

# =============================================================================
# MODERN CLI TOOLS
# =============================================================================

# eza (better ls)
if command -v eza &>/dev/null; then
  alias ls='eza --icons'
  alias ll='eza -la --icons --git'
  alias la='eza -a --icons'
  alias lt='eza --tree --level=2 --icons'
else
  alias ll='ls -lah'
  alias la='ls -A'
fi

# bat (better cat)
if command -v bat &>/dev/null; then
  alias cat='bat --paging=never'
  alias catp='bat'
  export BAT_THEME="gruvbox-dark"
fi

# fd (better find) and ripgrep (better grep)
command -v fd &>/dev/null && alias find='fd'
command -v rg &>/dev/null && alias grep='rg'

# =============================================================================
# TUI APPLICATIONS
# =============================================================================

# lazygit (visual git interface)
if command -v lazygit &>/dev/null; then
  alias lg='lazygit'
fi

# yazi (terminal file manager)
if command -v yazi &>/dev/null; then
  alias y='yazi'
fi

# glow (markdown viewer)
if command -v glow &>/dev/null; then
  alias mdcat='glow'
  alias mdview='glow -p'
fi

# jless (JSON viewer)
if command -v jless &>/dev/null; then
  alias jl='jless'
fi

# btop (system monitor) - no alias needed, just ensure it's available
command -v btop &>/dev/null

# lazydocker (docker TUI) - conditional if installed later
if command -v lazydocker &>/dev/null; then
  alias lzd='lazydocker'
fi

# =============================================================================
# NAVIGATION
# =============================================================================

alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'

# Zoxide (smart cd)
if command -v zoxide &>/dev/null; then
  eval "$(zoxide init zsh --cmd z)"
fi

# =============================================================================
# GIT
# =============================================================================

alias g='git'
alias gs='git status'
alias gd='git diff'
alias gds='git diff --staged'
alias ga='git add'
alias gaa='git add .'
alias gc='git commit'
alias gcm='git commit -m'
alias gp='git push'
alias gpl='git pull'
alias gl='git log --oneline -15'
alias glg='git log --graph --oneline --decorate'
alias gb='git branch'
alias gco='git checkout'
alias gcb='git checkout -b'

# =============================================================================
# FZF
# =============================================================================

if command -v fzf &>/dev/null; then
  if command -v fd &>/dev/null; then
    export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git'
    export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
    export FZF_ALT_C_COMMAND='fd --type d --hidden --follow --exclude .git'
  fi
  export FZF_DEFAULT_OPTS='
    --color=bg+:#3c3836,bg:#282828,spinner:#fb4934,hl:#928374
    --color=fg:#ebdbb2,header:#928374,info:#8ec07c,pointer:#fb4934
    --color=marker:#fb4934,fg+:#ebdbb2,prompt:#fb4934,hl+:#fb4934
    --height 40% --layout=reverse --border'
  [[ -f /opt/homebrew/opt/fzf/shell/completion.zsh ]] && source /opt/homebrew/opt/fzf/shell/completion.zsh
  [[ -f /opt/homebrew/opt/fzf/shell/key-bindings.zsh ]] && source /opt/homebrew/opt/fzf/shell/key-bindings.zsh
fi

# =============================================================================
# ATUIN & NAVI
# =============================================================================

command -v atuin &>/dev/null && eval "$(atuin init zsh)"
command -v navi &>/dev/null && eval "$(navi widget zsh)"

# =============================================================================
# STARSHIP
# =============================================================================

command -v starship &>/dev/null && eval "$(starship init zsh)"

# =============================================================================
# LANGUAGE TOOLS
# =============================================================================

command -v pyenv &>/dev/null && eval "$(pyenv init -)"
[[ -f "$HOME/.deno/env" ]] && source "$HOME/.deno/env"
[[ -f "$HOME/.local/bin/env" ]] && source "$HOME/.local/bin/env"

# =============================================================================
# FUNCTIONS
# =============================================================================

help() {
  echo "=== Command Discovery ==="
  echo "  navi     - Interactive cheatsheet (Ctrl+G)"
  echo "  tldr     - Simplified man pages"
  echo "  Ctrl+R   - History search (Atuin)"
  echo ""
  echo "=== Navigation ==="
  echo "  z <dir>  - Smart cd"
  echo "  zi       - Interactive directory picker"
  echo "  y        - Visual file manager (yazi)"
  echo ""
  echo "=== Files ==="
  echo "  ll       - List with icons and git"
  echo "  lt       - Tree view"
  echo "  fd       - Find files"
  echo "  rg       - Search in files"
  echo ""
  echo "=== Visual TUI Apps ==="
  echo "  lg       - Git interface (lazygit)"
  echo "  btop     - System monitor"
  echo "  y        - File manager (yazi)"
  echo "  mdcat    - Markdown viewer (glow)"
  echo "  jl       - JSON viewer (jless)"
  echo "  lzd      - Docker manager (lazydocker)"
  echo ""
  echo "=== AI ==="
  echo "  claude   - Claude Code"
  echo ""
  echo "Full cheatsheet: cat ~/Documents/GitHub/dotfiles/CHEATSHEET.md | bat"
}

mkcd() { mkdir -p "$1" && cd "$1" }

vf() {
  local file
  file=$(fd --type f | fzf --preview 'bat --style=numbers --color=always {}')
  [[ -n "$file" ]] && nvim "$file"
}

# =============================================================================
# ALIASES
# =============================================================================

alias reload='source ~/.zshrc'
alias v='nvim'
alias vim='nvim'
alias wezconfig='$EDITOR ~/.wezterm.lua'
alias starconfig='$EDITOR ~/.config/starship.toml'

[[ "$OSTYPE" == "darwin"* ]] && alias o='open' && alias finder='open -a Finder'
