# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Repository Purpose

Personal dotfiles repository for a modern, terminal-first macOS development environment. Managed by **chezmoi** for cross-machine synchronization.

**Critical**: This is NOT a standard git repository where files are directly edited. Source files are prefixed with `dot_` and managed by chezmoi.

## Architecture

### File Naming Convention

| Source File (in repo) | Target Location | Purpose |
|----------------------|-----------------|---------|
| `dot_wezterm.lua` | `~/.wezterm.lua` | WezTerm terminal config |
| `dot_zshrc` | `~/.zshrc` | Zsh shell config |
| `dot_config/starship.toml` | `~/.config/starship.toml` | Starship prompt |
| `dot_config/nvim/` | `~/.config/nvim/` | Neovim/LazyVim config |
| `macos-defaults.sh` | (run manually) | Idempotent macOS system defaults script |
| `macos-tuning.md` | (reference) | Full macOS tuning docs (scriptable + GUI-only) |
| `Brewfile` | (run via `brew bundle`) | All Homebrew formulae, casks, and taps |

**Never edit target files directly** - they will be overwritten by chezmoi.

### macOS System Customization

Three files track macOS system-level settings:

- **`macos-defaults.sh`** — executable script applying all scriptable `defaults write`, `launchctl disable`, and process restarts. Run with `bash macos-defaults.sh` after a fresh install or to reapply.
- **`macos-tuning.md`** — comprehensive documentation covering scriptable settings, GUI-only changes, one-time cleanup, and measured impact. Superset of what the script does.
- **`Brewfile`** — generated by `brew bundle dump --describe --force`. Restore with `brew bundle install`.

**Sync protocol:** When changing macOS defaults or brew packages, update the script, docs, and Brewfile together in a single commit. The excession repo has an auto-loaded rule (`.claude/rules/dotfiles.md`) enforcing this.

### Configuration Layers

1. **Terminal Layer**: WezTerm (Lua config) provides multiplexing, theming, keybindings, workspaces
2. **Shell Layer**: Zsh (primary) and Nushell (data processing) with modern CLI tool integration
3. **Prompt Layer**: Starship provides consistent prompt across all shells
4. **Editor Layer**: Neovim with LazyVim (managed in `dot_config/nvim/`)

### Modern CLI Tools Stack

The setup replaces traditional Unix tools with modern alternatives:
- `eza` replaces `ls` (icons, git status)
- `bat` replaces `cat` (syntax highlighting)
- `fd` replaces `find` (simpler syntax)
- `ripgrep` replaces `grep` (faster)
- `zoxide` replaces `cd` (smart navigation)
- `fzf` for fuzzy finding
- `atuin` for shell history
- `navi` for interactive cheatsheets

All tools are integrated in `dot_zshrc` with conditional loading.

## Common Workflows

### Making Configuration Changes

**ALWAYS use this workflow:**

```bash
# 1. Edit the source file in this repo
vim dot_zshrc  # or dot_wezterm.lua, etc.

# 2. Copy to home directory (chezmoi often fails to apply)
cp dot_zshrc ~/.zshrc
cp dot_wezterm.lua ~/.wezterm.lua
cp dot_config/starship.toml ~/.config/starship.toml

# 3. Test the change
source ~/.zshrc  # for zsh
# or Cmd+Shift+R in WezTerm

# 4. Commit
git add .
git commit -m "Description"
git push
```

**Note**: `chezmoi apply` should work but has proven unreliable in this setup. Direct file copying is more reliable.

### Adding New Dotfiles

```bash
# Add file to chezmoi tracking
chezmoi add ~/.gitconfig

# This creates dot_gitconfig in the repo
# Edit and manage like other dotfiles
```

### Theme Changes

WezTerm theme: `config.color_scheme = 'GruvboxDarkHard'` (line 14 of dot_wezterm.lua)
Starship colors: Defined using hex codes (Gruvbox palette) throughout dot_config/starship.toml

## Key Configuration Patterns

### WezTerm (dot_wezterm.lua)

- **Theme switcher**: `Ctrl+Shift+T` opens InputSelector with 10 preset themes
- **Workspaces**: `Cmd+Shift+P` project switcher, `Cmd+Shift+W` workspace list, `Cmd+Shift+[/]` cycle
- **Claude launcher**: `Cmd+Shift+C` splits right and runs claude
- **Help overlay**: `Cmd+Shift+/` shows quick-action key table
- **Keybindings**: macOS-style (`CMD` prefix) for panes, tabs, navigation
- **Window size**: `initial_cols = 140, initial_rows = 40` for reasonable default size
- **Gruvbox colors**: Custom tab_bar colors defined in `config.colors`

### Zsh (dot_zshrc)

- **PATH management**: Uses `typeset -U path` to prevent duplicates, then array assignment
- **Tool integration**: Each tool (eza, bat, etc.) has `if command -v` conditional loading
- **Functions**: Helper functions like `help()`, `vf()` for fuzzy file opening
- **Aliases**: Modern tool aliases that maintain muscle memory (`ll`, `cat`, etc.)

### Starship (dot_config/starship.toml)

- **Minimalist design**: Only directory, git, and character by default
- **Right prompt**: Command duration and language indicators
- **Gruvbox colors**: All colors use hex codes matching Gruvbox palette
- **Disabled modules**: Most language/tool modules disabled to keep prompt clean

## Neovim Configuration

Neovim config is tracked in `dot_config/nvim/` and deployed to `~/.config/nvim/`. Uses LazyVim v8 with extras:
- `neo-tree` (file explorer sidebar)
- `gruvbox-material` (colorscheme)
- `avante.nvim` (AI coding assistant)
- `render-markdown.nvim` (markdown rendering)
- `claude.nvim` (Claude Code integration)

**Excluded from tracking:** `lazy-lock.json`, `.git/`, `LICENSE`, `README.md`, `.neoconf.json`

## Important Constraints

### User Preferences
- **Beginner-friendly**: User is terminal beginner, needs command discovery tools (navi, tldr, which-key)
- **No memorization**: Design patterns around discovery, not memory
- **Gruvbox aesthetic**: All themes should use Gruvbox or be easily switchable
- **macOS primary**: Optimized for macOS but maintains some cross-platform references

### Technical Constraints
- **Shell loading**: Tools must conditionally load (check with `command -v`) to avoid errors
- **PATH ordering**: Homebrew paths must come before system paths
- **Nushell separate**: Nushell config lives in `~/Library/Application Support/nushell/`
- **Window size**: Default 140×40 prevents fullscreen waste on wide monitors

## Troubleshooting Patterns

### "command not found" on shell startup
- Check PATH is set before tool initialization
- Verify tool exists: `which <tool>` or `brew list | grep <tool>`
- Tools should have fallback behavior (see eza alias block)

### Config not applying
- Don't rely on `chezmoi apply` - copy files directly
- After copying, reload: `source ~/.zshrc` or restart WezTerm
- Check file permissions: configs should be readable

### Merge conflicts
- This repo has multiple work streams, expect conflicts
- Source files (`dot_*`) are source of truth
- When conflicted: keep working version, test, then commit

## What NOT to Do

- Don't edit `~/.zshrc` directly - edit `dot_zshrc` in repo
- Don't add complex abstractions - keep configs readable
- Don't assume tools are installed - always check with `command -v`
- Don't use `chezmoi edit` - it's inconsistent, edit files directly
- Don't add Oh-My-Zsh or similar frameworks - this is a minimal setup
